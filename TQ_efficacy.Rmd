---
title: "Clinical Pharmacology of Tafenoquine for the radical cure of vivax malaria"
author: "James Watson"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = T, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)
library(haven)
library(sjlabelled)
library(lme4)
library(survival)
library(survminer)
library(rstan)
library(rstanarm)
library(RColorBrewer)
options(mc.cores = parallel::detectCores())
```

TODO:

-   Run with updated PK output
-   Paper: check effect in volunteers
-   Analysis just with DETECTIVE part 1 (randomised allocation)
-   Boxplot of half lives across regions
-   Association with weight (just in placebo arms)

# Preambule

## Load data

```{r load_data}
# WWARN collated baseline and outcome data
outcome_dat = read_dta('an1_tq_efficacy.dta')
outcome_dat$study = 
  plyr::mapvalues(outcome_dat$sid, 
                  from = c('BSAJK',
                           'KTMTV',
                           'PRSXC'),
                  to = c('GATHER',
                         'DETECTIVE_Ph3',
                         'DETECTIVE_Ph2'))
table(outcome_dat$study)
outcome_dat$studysite = as.factor(outcome_dat$studysite)

# changes to database:
outcome_dat$tqmgkgtot[outcome_dat$pid=='KTMTV_13_0870'] = 300/100.7 # error in database
outcome_dat$tqmgkgtot[outcome_dat$pid=='KTMTV_03_0197'] = 300/51.5 # error in database
outcome_dat = outcome_dat[outcome_dat$pid != 'BSAJK_6_219', ] # BSAJK_6_219 vomited but was not re-dosed
outcome_dat = outcome_dat[!is.na(outcome_dat$logpara0), ] # PRSXC_04_0276 had neg parasitaemia at enrolment
outcome_dat$pqmgkgtot[outcome_dat$pid=='KTMTV_13_0020'] = 14*15/72.3

outcome_dat$pqmgkgtot[is.na(outcome_dat$pqmgkgtot)]=0
outcome_dat$AMT = paste0('TQ', round(outcome_dat$weight*outcome_dat$tqmgkgtot))
outcome_dat$AMT[outcome_dat$pqmgkgtot>0] = 'PQ15'
outcome_dat$AMT[outcome_dat$AMT=='TQ0'] = 'No Radical Cure'
writeLines('TQ doses in efficacy analyses:')
table(outcome_dat$AMT)

# Define the sensitivity analysis subgroup (300 mg dose)
ind_sensitivity = outcome_dat$AMT == 'TQ300'
sum(ind_sensitivity)

outcome_dat$outcome7to120 = outcome_dat$outcome7to180
outcome_dat$outcome7to120[which(outcome_dat$malariaday>127)] = 0

# DEFINITION OF PRIMARY OUTCOME
outcome_dat$outcome_primary = outcome_dat$outcome7to120
max(outcome_dat$tqmgkgtot[which(outcome_dat$outcome_primary==1)])
max(outcome_dat$pqmgkgtot[which(outcome_dat$outcome_primary==1)])

ind_rm_endpoint_binary = is.na(outcome_dat$malariaday) & outcome_dat$dlast<=30
ids_exclude = unique(outcome_dat$pid[ind_rm_endpoint_binary])
write.csv(data.frame(pid=ids_exclude), file = 'ids_exclude.csv',row.names = F, quote = F)
writeLines(sprintf('%s patients were lost to follow-up before 1 month',sum(ind_rm_endpoint_binary)))
writeLines(sprintf('%s patients were lost to follow-up before 4 months',sum(is.na(outcome_dat$malariaday) & outcome_dat$dlast<105)))
writeLines(sprintf('%s patients were lost to follow-up before 6 months',sum(is.na(outcome_dat$malariaday) & outcome_dat$dlast<164)))

# if less than 1 month follow-up then remove from analysis
outcome_dat$outcome_primary[ind_rm_endpoint_binary]=NA
outcome_dat$outcome7to180[ind_rm_endpoint_binary]=NA

ind_efficacy = !is.na(outcome_dat$outcome_primary)
table(outcome_dat$AMT[ind_efficacy])
writeLines(sprintf('A total of %s patients received TQ in the efficacy population with doses varying from %s to %s mg/kg',
                   sum(ind_efficacy & outcome_dat$tqmgkgtot>0),
                   round(min(outcome_dat$tqmgkgtot[ind_efficacy & outcome_dat$tqmgkgtot>0]),1),
                   round(max(outcome_dat$tqmgkgtot[ind_efficacy & outcome_dat$tqmgkgtot>0]),1)))

table(outcome_dat$outcome_primary)
table(outcome_dat$outcome7to180)

## PK summaries statistics from Joel
pk_summaries = read.csv('TQ_PK_summaries.csv')
outcome_dat = merge(outcome_dat, pk_summaries, by.x = 'pid', by.y = 'PID', all.x = T)
# rescale AUC by factor of 1000
outcome_dat$AUC = outcome_dat$AUC/1000

# CYP2D6 genotyping
cyp2d6 = read.csv('CYP2D6.csv')
outcome_dat = merge(outcome_dat, cyp2d6, by = 'pid', all.x = T)

# Methaemoglobin: removed all measurements taken at/after recurrence
mthb_dat = read.csv('Methb_long.csv')
pk_summaries = merge(pk_summaries, # add tqmgkgtot to pk_summaries
                     mthb_dat[!duplicated(mthb_dat$pid), c('pid','tqmgkgtot')],
                     by.x = 'PID', by.y='pid', all.x = T)

pk_summaries = merge(pk_summaries, # add primary outcome to pk_summaries
                     outcome_dat[,c('pid','outcome_primary')],
                     by.x = 'PID', by.y='pid', all.x = T)

# Day 28 CQ level
day28CQ = read.csv('CQ_day_28.csv')
day28CQ$Day_28_CQ = as.numeric(day28CQ$Day_28_CQ)
outcome_dat = merge(outcome_dat, day28CQ, by='pid', all.x=T)
```

# Data summaries

## Table 1

```{r}
outcome_dat$tqcat = as.character(cut(outcome_dat$tqmgkgtot,
                                     breaks = c(0,.01,3.75,6.25,8.75,15),
                                     include.lowest = T,right = F))
outcome_dat$tqcat[outcome_dat$pqmgkgtot>0]='PQ'
outcome_dat$tqcat[outcome_dat$pqmgkgtot==0 & outcome_dat$tqmgkgtot==0]='No radical cure'
outcome_dat$tqcat = factor(outcome_dat$tqcat, levels = c('No radical cure',
                                                         'PQ',
                                                         "[0.01,3.75)",
                                                         "[3.75,6.25)",
                                                         "[6.25,8.75)",
                                                         "[8.75,15]"))

outcome_dat$tqcat[ind_rm_endpoint_binary]=NA
print(aggregate(tqmgkgtot ~ tqcat, data = outcome_dat, mean))
t1=aggregate(outcome_primary ~ tqcat, data = outcome_dat, function(x) round(100*mean(x),1))
t2=aggregate(outcome_primary ~ tqcat, data = outcome_dat, sum)
t3=aggregate(outcome_primary ~ tqcat, data = outcome_dat, length)
xx=cbind(t1, t2[,2], t3[,2])
colnames(xx)[2:4] = c('mean','n','total')
print(xx)

writeLines('mean age:')
print(aggregate(age ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(mean(x))))
writeLines('SD age:')
print(aggregate(age ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(sd(x),1)))

print(aggregate(sex ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) sum(x==2)))
print(aggregate(sex ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(100*mean(x==2))))

print(aggregate(weight ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(mean(x))))
print(aggregate(weight ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(sd(x),1)))

xx=table(outcome_dat$country[ind_efficacy], outcome_dat$tqcat[ind_efficacy])
print(xx)
for(i in 1:ncol(xx)){
  xx[,i] = round(100*xx[,i]/sum(outcome_dat$tqcat==levels(outcome_dat$tqcat)[i],na.rm=T))
}
print(xx)

print(aggregate(logpara0 ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(10^quantile(x))))

print(aggregate(hbday0 ~ tqcat, data = outcome_dat[ind_efficacy, ], function(x) round(c(mean(x), sd(x)),1)))

```

## PK data plot

For supplementary materials

```{r pk_data_plot}
pk_database = readr::read_csv('../../Tafenoquine_PK_datsets/All_TQ_PK_data.csv',na = '.')[-1, ]
for(id in unique(pk_database$PID)){
  pk_database$AMT[pk_database$PID==id] =
    pk_database$AMT[pk_database$CMT==1 & pk_database$PID==id]
}

pk_database = pk_database[pk_database$CMT==2 & pk_database$BLQ==0, ] # get just observed concs
pk_database$AMT = as.numeric(pk_database$AMT)
pk_database$AMT_col = as.factor(pk_database$AMT)
cols = RColorBrewer::brewer.pal(n = 4, 'Dark2')

writeLines(sprintf('there are a total of %s concentrations above LOQ in %s patients',nrow(pk_database), length(unique(pk_database$PID))))

pk_database$PID=gsub(x = pk_database$PID, pattern = 'BSAJK',replacement = 'GATHER')
pk_database$PID=gsub(x = pk_database$PID, pattern = 'KTMTV',replacement = 'DETECTIVE Part 2')
pk_database$PID=gsub(x = pk_database$PID, pattern = 'PRSXC',replacement = 'DETECTIVE Part 1')
pk_database$PID=gsub(x = pk_database$PID, pattern = 'Phase1',replacement = 'Phase 1')

pk_database$log_conc = log10(exp(as.numeric(pk_database$LNDV)))
pk_database$TIME = as.numeric(pk_database$TIME)/24

studies = c('Phase 1', 'DETECTIVE Part 1', 'DETECTIVE Part 2', 'GATHER')

ind_phase1 = grep('Phase 1', pk_database$PID)
par( las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
hist(table(pk_database$PID[- ind_phase1]), 
     xlab='Number of plasma tafenoquine samples > LOQ',
     main='', ylab = 'Number of patients',
     breaks = seq(0.5, 8.5, by=1), xaxt='n')
axis(1, at=1:8)
par(mfrow=c(2,2))
for(ss in studies){
  ind = grep(ss, x = pk_database$PID)
  plot(pk_database$TIME[ind], pk_database$log_conc[ind], ylab='Plasma tafenoquine (ng/ml)',
       xlab='Days since dose', xlim=range(pk_database$TIME),
       ylim= range(pk_database$log_conc), panel.first=grid(),
       main= paste0(ss, ' (n=', length(unique(pk_database$PID[ind])),')'),
       yaxt='n', col = cols[pk_database$AMT_col[ind]])
  axis(2, at = 1:3, labels = 10^(1:3))
}

legend('topright', legend = levels(pk_database$AMT_col), cex=1.5,
       col = cols, pch=1, title = 'TQ dose',inset = 0.03)
```

## Kaplan Meier time to recurrence

```{r KM_plot}
outcome_dat$censored = as.numeric(!is.na(outcome_dat$malariaday))
survmod = survfit(Surv(dlast, censored) ~ tqcat, data = outcome_dat[ind_efficacy, ])
xx=summary(survmod)
print(xx$n)
mycols = brewer.pal(n = 6, 'Set2')

ggsurvplot(survmod, 
           linetype = c(1,1,2,2,2,2), 
           censor = T, xlim=c(0,180), ylim=c(0,1), 
           xlab='Days from treatment',
           break.x.by=30,palette = 'Set2',
           legend.labs = c('No TQ',
                           'PQ 1.76-6.0 mg/kg',
                           'TQ <3.75 mg/kg',
                           'TQ 3.75-6.25 mg/kg',
                           'TQ 6.25-8.75 mg/kg',
                           'TQ >8.75 mg/kg'), 
           risk.table.y.text.col	= T,
           fun = function(x) x,
           risk.table = T,risk.table.y.text=F,
           legend.title='', ylab='Risk of recurrence', 
           surv.scale='percent', 
           ggtheme = theme_survminer(base_family='serif'))
```

```{r data_summaries}
table(outcome_dat$country, outcome_dat$tqcat)

writeLines('Range of mg/kg weights:')
round(range(outcome_dat$tqmgkgtot[outcome_dat$tqmgkgtot>0]),2)

xx = aggregate(hgbmet ~ pid, data = mthb_dat, length)
writeLines(sprintf('Median number of methb measurements is %s (range %s to %s)',
                   median(xx$hgbmet),
                   range(xx$hgbmet)[1],
                   range(xx$hgbmet)[2]))

table(outcome_dat$outcome_primary)
table(outcome_dat$tqcat, outcome_dat$outcome_primary)

xx=aggregate(outcome_primary ~ tqcat, data = outcome_dat, 
             FUN = function(x) c(round(100*mean(x),1), length(x)))
colnames(xx$outcome_primary)=c('Rec 4 mths (%)', 'n')
colnames(xx)[1]='Dose (mg)'; colnames(xx)[2]=''
print(xx)
```

## CYP2D6

```{r}
table(is.na(outcome_dat$CYP2D6))
table(outcome_dat$CYP2D6, outcome_dat$CYP2D6AS)
diplotypes = strsplit(outcome_dat$CYP2D6, split = '/')

writeLines('CYP2D6 allele frequencies:')
round(100*table(unlist(diplotypes))/sum(table(unlist(diplotypes))),1)

ASscore_key = data.frame(name=c('*1', '*10', '*2', '*36', '*39', '*4', '*5', '*3', '*6', '*9', '*17', '*41'),
                         score=c(1,   0.25,   1,     0,     1,    0,     0,   0.5,  0.5,  0.5,  0.5,   0.5))

# Make updated AS score
outcome_dat$AS_score = NA
for(i in 1:nrow(outcome_dat)){
  if(!is.na(outcome_dat$CYP2D6AS[i])){
    my_dp = diplotypes[[i]]
    outcome_dat$AS_score[i] =
      ASscore_key$score[which(ASscore_key$name == my_dp[1])]+
      ASscore_key$score[which(ASscore_key$name == my_dp[2])]
  }
}

table(outcome_dat$AS_score, outcome_dat$CYP2D6AS)
table(`CYP2D6 Genotype` = outcome_dat$CYP2D6, `Activity Score` = outcome_dat$AS_score)
```

## Basic data plots

weight

```{r weight_plot}
ind = (outcome_dat$AMT=='TQ300')
fail_rates = aggregate(outcome_primary ~ country, outcome_dat[ind, ], 
                       function(x) c(round(100*mean(x)), length(x)))
print(fail_rates)
fail_rates_all = aggregate(outcome_primary ~ country, outcome_dat, 
                           function(x) c(round(100*mean(x)), length(x)))
print(fail_rates_all)
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3, mfrow=c(3,3))
for(cc in unique(outcome_dat$country)){
  hist(outcome_dat$weight[outcome_dat$country==cc],main=cc,xlab='kg',
       breaks = seq(30, 140, by=5), ylab='Number of patients')
  abline(v = median(outcome_dat$weight[outcome_dat$country==cc]), lty=1,lwd=3,col='red')
}

xx=aggregate(weight ~ country , outcome_dat, function(x) round(median(x)))
xx = dplyr::arrange(xx, weight)
print(xx)
```

## Methb data

```{r methaemoglobin_prep}
writeLines(sprintf('There are a total of %s mthb measurements in %s patients',
                   nrow(mthb_dat),length(unique(mthb_dat$pid))))
ind = mthb_dat$time_since_dose>=0 & mthb_dat$time_since_dose<20
writeLines(sprintf('Between day 0 and day 20 there are %s measurements. Median (range) per patient is %s (%s to %s)',
                   sum(ind),
                   median(table(mthb_dat$pid[ind])),
                   quantile(table(mthb_dat$pid[ind]),0),
                   quantile(table(mthb_dat$pid[ind]),1)))
par(las=1)
plot(mthb_dat$time_since_dose[ind], jitter(log10(mthb_dat$hgbmet[ind])),
     xlab='Day since dose', ylab='Methaemoglobin (log %)', panel.first=grid())


# make a linear interpolation matrix for the longitudinal methb values
mthb_mat = array(dim = c(length(unique(mthb_dat$pid)),30))
rownames(mthb_mat) = unique(mthb_dat$pid)

for(i in 1:nrow(mthb_mat)){
  ind = mthb_dat$pid==rownames(mthb_mat)[i]
  # linear interpolation function
  f_mthb = approxfun(x = mthb_dat$time_since_dose[ind], y = mthb_dat$hgbmet[ind],ties = 'mean')
  mthb_mat[i, ] = f_mthb(0:29)
}
# extract the day 7 methb
day_7_mthb = data.frame(pid = rownames(mthb_mat), day7_mthb=mthb_mat[,8])
write.csv(x = day_7_mthb, file = 'day_7_mthb.csv')
pk_summaries = merge(pk_summaries, day_7_mthb, by.x = 'PID',by.y='pid', all.x=T)





par(las=1, mfrow=c(2,2), cex.lab=1.4, cex.axis=1.3)
ids = unique(pk_summaries$PID[pk_summaries$tqmgkgtot>=3.75 &
                                pk_summaries$tqmgkgtot<6.25])
plot(0:29, colMeans(mthb_mat[rownames(mthb_mat) %in% ids, ],na.rm = T),
     type='l',lwd=3, ylim = c(0, 6.5), ylab='MetHb (%)',
     xlab='Days since dose', panel.first=grid(), 
     main=paste0('3.75-6.25 mg/kg (n=',length(ids),')'))
lines(0:29, apply(mthb_mat[rownames(mthb_mat) %in% ids, ],2, quantile, probs=.1, na.rm = T))
lines(0:29, apply(mthb_mat[rownames(mthb_mat) %in% ids, ],2, quantile, probs=.9, na.rm = T))
abline(v=7, lty=2)
mtext(text = 'a',side = 3,adj = 0,line = 1.5,cex=1.5)

# Above 6.25 mg/kg
ids = unique(pk_summaries$PID[pk_summaries$tqmgkgtot>=6.25])
plot(0:29, colMeans(mthb_mat[rownames(mthb_mat) %in% ids, ],na.rm = T),
     type='l',lwd=3, ylim = c(0, 6.5), ylab='MetHb (%)',
     xlab='Days since dose',
     panel.first=grid(), main=paste0('>6.25 mg/kg (n=',length(ids),')'))
lines(0:29, apply(mthb_mat[rownames(mthb_mat) %in% ids, ],2, quantile, probs=.1, na.rm = T))
lines(0:29, apply(mthb_mat[rownames(mthb_mat) %in% ids, ],2, quantile, probs=.9, na.rm = T))
abline(v=7, lty=2)
mtext(text = 'b',side = 3,adj = 0,line = 1.5,cex=1.5)


plot(pk_summaries$tqmgkgtot, log10(pk_summaries$day7_mthb), yaxt='n',
     ylab='Day 7 MetHb (%)', xlab='Tafenoquine dose (mg/kg)',
     ylim = log10(c(0.3, 10)),col=pk_summaries$outcome_primary+1,
     panel.first=grid(),
     pch = pk_summaries$outcome_primary*15+1)
axis(2, at = 0:1, labels = 10^(0:1))
axis(2, at = log10(c(0.3, 3)), labels = c(0.3, 3))
axis(2, at = log10(seq(0.3, 1, by=.1)), labels = NA)
axis(2, at = log10(seq(1, 10, by=1)), labels = NA)
mtext(text = 'c',side = 3,adj = 0,line = 1.5,cex=1.5)

# linear fit
mod_day7 = lm(log10(day7_mthb) ~ tqmgkgtot, data=pk_summaries)
lines(0:15, predict(mod_day7, data.frame(tqmgkgtot=0:15)),lty=2,lwd=3)

pk_summaries$t_12_terminal_rescaled[!is.na(pk_summaries$t_12_terminal_rescaled) & pk_summaries$t_12_terminal_rescaled>31]=NA

mod_day7_3 = lm(log10(day7_mthb) ~ tqmgkgtot,
                data=pk_summaries)
summary(mod_day7_3)

mod_day7_3 = MASS::rlm(log10(day7_mthb) ~ tqmgkgtot + t_12_terminal_rescaled,
                       data=pk_summaries)
plot(pk_summaries$t_12_terminal_rescaled, log10(pk_summaries$day7_mthb),
     xlab=expression(paste(t[1/2], ' (days)')), 
     ylab = 'Day 7 MetHb (%)', ylim = log10(c(.3, 10)),
     panel.first=grid(), yaxt='n',col=pk_summaries$outcome_primary+1,
     pch = pk_summaries$outcome_primary*15+1)

axis(2, at = 0:1, labels = 10^(0:1))
axis(2, at = log10(c(0.3, 3)), labels = c(0.3, 3))
axis(2, at = log10(seq(0.3, 1, by=.1)), labels = NA)
axis(2, at = log10(seq(1, 10, by=1)), labels = NA)
mtext(text = 'd',side = 3,adj = 0,line = 1.5,cex=1.5)

lines(5:30, predict(mod_day7_3, data.frame(tqmgkgtot=5, t_12_terminal_rescaled=5:30)),lwd=3,lty=2)
```




```{r mgkg_AUC}
outcome_dat = merge(outcome_dat, day_7_mthb, by = 'pid', all.x=T)
par(las=1, cex.axis=1.3, cex.lab=1.3,family='serif')
plot(outcome_dat$tqmgkgtot, outcome_dat$AUC,
     xlab='TQ (mg/kg)',col=as.numeric(ind_sensitivity)+1,
     ylab = 'TQ AUC (rescaled)', panel.first=grid())
mod = lm(AUC ~ tqmgkgtot, data = outcome_dat)
lines(0:14, predict(mod, data.frame(tqmgkgtot=0:14)),lwd=3, col='darkblue')

mod = mgcv::gam(AUC ~ s(tqmgkgtot,k=3), data = outcome_dat)
lines(0:14, predict(mod, data.frame(tqmgkgtot=0:14)),lwd=3, col='darkblue')
```




```{r terminal_half_life}
par(las=1, cex.axis=1.3, cex.lab=1.3)
hist(pk_summaries$t_12_terminal_rescaled, xlim = c(0,30),
     xlab='Terminal elimination half life (days)', breaks = 30,main='',
     yaxt='n',ylab='')
median(pk_summaries$t_12_terminal_rescaled, na.rm = T)

summary(lm(t_12_terminal_rescaled ~ AS_score<=0.5, data = outcome_dat))
boxplot(day7_mthb ~ AS_score, data = outcome_dat)
```

# Weight based models of tafenoquine efficacy

## Logistic regression

```{r models1}
mod_mgkg_all = stan_glmer(outcome_primary ~ pqmgkgtot + tqmgkgtot + logpara0 + (1|studysite),
                          family='binomial', data = outcome_dat,
                          verbose=FALSE,refresh=0)
writeLines(sprintf('Using all data (n=%s), the odds ratio for recurrence at 4 months for each additional mg/kg of tafenoquine is %s (95%% CI %s to %s)',
                   nobs(mod_mgkg_all),
                   round(exp(fixef(mod_mgkg_all)['tqmgkgtot']),2),
                   round(exp(posterior_interval(mod_mgkg_all,pars='tqmgkgtot',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mgkg_all,pars='tqmgkgtot',prob = 0.95)[2]),2)))

writeLines(sprintf('Using all data (n=%s), the odds ratio for recurrence at 4 months for each additional mg/kg of primaquine is %s (95%% CI %s to %s)',
                   nobs(mod_mgkg_all),
                   round(exp(fixef(mod_mgkg_all)['pqmgkgtot']),2),
                   round(exp(posterior_interval(mod_mgkg_all,pars='pqmgkgtot',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mgkg_all,pars='pqmgkgtot',prob = 0.95)[2]),2)))

mod_mgkg_sens = stan_glmer(outcome_primary ~ tqmgkgtot + logpara0 + (1|studysite),
                           family='binomial', data = outcome_dat[ind_sensitivity, ],
                           verbose=FALSE,refresh=0)
writeLines(sprintf('Using only patients who got a 300 mg dose (n=%s), the odds ratio for recurrence at 4 months for each additional mg/kg of tafenoquine is %s (95%% CI %s to %s)',
                   nobs(mod_mgkg_sens),
                   round(exp(fixef(mod_mgkg_sens)['tqmgkgtot']),2),
                   round(exp(posterior_interval(mod_mgkg_sens,pars='tqmgkgtot',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mgkg_sens,pars='tqmgkgtot',prob = 0.95)[2]),2)))


mod_mgkg_all_6mths = stan_glmer(outcome7to180 ~ pqmgkgtot + tqmgkgtot + logpara0 + (1|studysite),
                                family='binomial', data = outcome_dat,
                                verbose=FALSE,refresh=0)
writeLines(sprintf('Using all patients (n=%s), the odds ratio for recurrence at 6 months for each additional mg/kg of tafenoquine is %s (95%% CI %s to %s)',
                   nobs(mod_mgkg_all_6mths),
                   round(exp(fixef(mod_mgkg_all_6mths)['tqmgkgtot']),2),
                   round(exp(posterior_interval(mod_mgkg_all_6mths,pars='tqmgkgtot',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mgkg_all_6mths,pars='tqmgkgtot',prob = 0.95)[2]),2)))

writeLines(sprintf('Using all patients (n=%s), the odds ratio for recurrence at 6 months for each additional mg/kg of primaquine is %s (95%% CI %s to %s)',
                   nobs(mod_mgkg_all_6mths),
                   round(exp(fixef(mod_mgkg_all_6mths)['pqmgkgtot']),2),
                   round(exp(posterior_interval(mod_mgkg_all_6mths,pars='pqmgkgtot',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mgkg_all_6mths,pars='pqmgkgtot',prob = 0.95)[2]),2)))
```

## EMAX model

```{r emax_fitting, include=FALSE}
RUN_MODELS = F
fname = 'Rout/emax_fits.RData'
pred_x = seq(0,15,length.out=1000)
emax_stan = stan_model(file = 'Emax_logit.stan') # compile model

if(RUN_MODELS | !file.exists(fname)){
  emax_stan = stan_model(file = 'Emax_logit.stan') # compile model
  
  # only patients with recorded outcome (excludes those who dropped out after 1 month FUP)
  ind_include = !is.na(outcome_dat$outcome_primary)
  mod_emax_all = 
    sampling(emax_stan, 
             data=list(N=sum(ind_include),
                       Ksites = length(unique(outcome_dat$studysite[ind_include])),
                       recurrence = outcome_dat$outcome_primary[ind_include],
                       dose_mg_kg = outcome_dat$tqmgkgtot[ind_include],
                       K_cov = 2,
                       x = matrix(cbind(outcome_dat$pqmgkgtot[ind_include],
                                        outcome_dat$logpara0[ind_include]),
                                  nrow = sum(ind_include)),
                       studysite = as.numeric(as.factor(as.character(outcome_dat$studysite[ind_include]))),
                       K=length(pred_x),
                       pred_x = pred_x),
             save_warmup = FALSE,iter=4000, thin=5,
             pars=c('theta'), # we don't save these as it takes up vast memory!
             include=FALSE,
             verbose=FALSE,refresh=0)
  
  
  mod_emax_all_6mths = 
    sampling(emax_stan, 
             data=list(N=sum(ind_include),
                       Ksites = length(unique(outcome_dat$studysite[ind_include])),
                       recurrence = outcome_dat$outcome7to180[ind_include],
                       dose_mg_kg = outcome_dat$tqmgkgtot[ind_include],
                       K_cov = 2,
                       x = matrix(cbind(outcome_dat$pqmgkgtot[ind_include],
                                        outcome_dat$logpara0[ind_include]),
                                  nrow = sum(ind_include)),
                       studysite = as.numeric(as.factor(as.character(outcome_dat$studysite[ind_include]))),
                       K=length(pred_x),
                       pred_x = pred_x),
             save_warmup = FALSE,iter=4000, thin=5,
             pars=c('theta'), # we don't save these as it takes up vast memory!
             include=FALSE,
             verbose=FALSE,refresh=0)
  
  save(mod_emax_all, mod_emax_all_6mths, file = fname)
} else {
  load(file = fname)
}
```

load fits

```{r traceplots}
mypars = c('E0','Emax','ED50','k','beta','pred_y')
thetas_all=extract(mod_emax_all,pars=mypars)
thetas_all_6mths=extract(mod_emax_all_6mths,pars=mypars)

traceplot(mod_emax_all,pars=mypars[1:5])
traceplot(mod_emax_all_6mths,pars=mypars[1:5])
```

### Compare EMAX model fits

```{r emax_fits}
par(las=1, mfrow=c(2,2), family='serif',bty='n')
# E0
plot(density(thetas_all$E0),main='', xlab='E0', ylab='', yaxt='n', 
     xlim=c(-3, 1),panel.first=grid(),lwd=3)
lines(density(thetas_all_6mths$E0),lty=2,lwd=3)
xs=seq(-3,1,length.out=100)
lines(xs, dnorm(xs, 0, 2), lwd=3, col='red')

# Emax
plot(density(thetas_all_6mths$Emax),main='', xlab='Emax', lty=2,ylab='', yaxt='n', xlim=c(-15,0), panel.first=grid(),lwd=3)
lines(density(thetas_all$Emax),lty=1,lwd=3)
xs=seq(-15,0,length.out=100)
lines(xs, dnorm(xs, -5, 5), lwd=3, col='red')
legend('topleft', lty=1:2, lwd=2, legend = c('4 months', '6 months'))

# ED50
plot(density(thetas_all$ED50),main='', xlab='ED50 (mg/kg)', ylab='', yaxt='n', xlim=c(0,20), panel.first=grid(),lwd=3)
lines(density(thetas_all_6mths$ED50),lty=2,lwd=3)
xs=seq(0,20,length.out=100)
lines(xs, dnorm(xs, 5, 5), lwd=3, col='red')

# k
plot(density(thetas_all_6mths$k),main='', xlab='k', lty=2,ylab='', yaxt='n', xlim=c(0,4), panel.first=grid(),lwd=3)
lines(density(thetas_all$k),lty=1,lwd=3)
xs=seq(0,4,length.out=100)
lines(xs, dnorm(xs, 1, 2), lwd=3, col='red')
```

```{r}
# my_k = mean(thetas_all$k)
# my_ed50 = mean(thetas_all$ED50)
# my_emax = mean(thetas_all$Emax)
# my_e0 = mean(thetas_all$E0)
# 
# writeLines(sprintf('Mean recurrence estimate at 4 months:\n for 3 mg/kg is %s%%;\n for 4 mg/kg is %s%%;\n for 5 mg/kg is %s%%;\n for 6 mg/kg is %s;\n for 7 mg/kg id %s;\n for 10 mg/kg is %s;',
#                    round(100*(invlogit(my_e0 + (my_emax*3^my_k)/(3^my_k+my_ed50^my_k))),1),
#                    round(100*(invlogit(my_e0 + (my_emax*4^my_k)/(4^my_k+my_ed50^my_k))),1),
#                    round(100*(invlogit(my_e0 + (my_emax*5^my_k)/(5^my_k+my_ed50^my_k))),1),
#                    round(100*(invlogit(my_e0 + (my_emax*6^my_k)/(6^my_k+my_ed50^my_k))),1),
#                    round(100*(invlogit(my_e0 + (my_emax*7^my_k)/(7^my_k+my_ed50^my_k))),1),
#                    round(100*(invlogit(my_e0 + (my_emax*10^my_k)/(10^my_k+my_ed50^my_k))),1)))
```

Figure 2 in paper: the main mg/kg driving efficacy plot under the EMAX model

```{r emax}
ind_include = !is.na(outcome_dat$outcome_primary)
para_density=median(outcome_dat$logpara0[ind_include])
for(i in 1:length(pred_x)){
  thetas_all$pred_y[,i] = thetas_all$pred_y[,i]+(thetas_all$beta[,2]*para_density)
}
ps = invlogit(apply(thetas_all$pred_y,2,mean) )
p0 = ps[1]
p15 = ps[length(pred_x)]

ps[which.min(abs(pred_x-3))]
ps[which.min(abs(pred_x-4))]
ps[which.min(abs(pred_x-5))]

writeLines(sprintf('The model estimates that a 15 mg/kg TQ dose reduces %s%% of all recurrences at 4 months',
                   round((1-p15/p0)*100,2)))

mycols = brewer.pal(n = 12,name = 'Paired')[c(2,6,10)]
layout(mat = matrix(c(1,2,2,2,2,2),nrow = 6))
par(las=1, cex.lab=1.5, cex.axis=1.5,mar=c(0,5,2,2), family='serif')
hist(outcome_dat$tqmgkgtot[outcome_dat$pqmgkgtot==0],
     ylab='',xaxt='n',xlab='',yaxt='n',col = brewer.pal(8,'Pastel2')[7],
     main='', breaks = seq(0,15,by=.5))
par(las=1, cex.lab=1.8, cex.axis=1.8,mar=c(6,6,0,2))
plot(pred_x, 100*ps, lwd=3, type='l',
     xlab = '',col=mycols[1],
     ylab = '',
     ylim = c(0,65), panel.first=grid())
mtext(text = substitute(paste(italic("P. vivax "), 'recurrence (%)')), 
      side = 2,line = 3,las=3,cex=1.6)
mtext(text = 'Single dose tafenoquine (mg/kg)', 
      side = 1,line = 3,las=1,cex=1.6)
abline(h = 100*invlogit(mean(thetas_all$E0 + 
                               3.5*thetas_all$beta[,1] + 
                               para_density*thetas_all$beta[,2])),
       lty=1, lwd=2,col='darkred')
polygon(c(-10,-10, 100, 100), 
        100*invlogit(quantile(thetas_all$E0 + 
                                3.5*thetas_all$beta[,1]+ 
                                para_density*thetas_all$beta[,2],
                              probs = c(0.025,.975,.975,.025))),
        col = adjustcolor('pink',.3), border = NA)
text(x = 10, y = 2+100*invlogit(mean(thetas_all$E0 + 3.5*thetas_all$beta[,1]+
                                       para_density*thetas_all$beta[,2])),
     'Low-dose primaquine (3.5 mg/kg)',cex=2)

polygon(x = c(pred_x, rev(pred_x)),
        y = 100*invlogit(c(apply(thetas_all$pred_y, 2, quantile, .975),
                           rev(apply(thetas_all$pred_y, 2, quantile, .25)))),
        border = NA, col = adjustcolor(mycols[1], .4))
lines(pred_x, 100*ps, lwd=3,col=mycols[1])


# Max obtainable effect
lines(c(-10, 15), rep(100*p15, 2),lty=2)
lines(c(15, 15), c(-19, 100*p15),lty=2)
text(x = 1.5, y = 100*p15 + 2, expression(E[max]),cex=2)

# E90
x_90 = pred_x[which.min(abs((1-ps/p0) - 0.9*(1-p15/p0)))]
writeLines(sprintf('The E90 is %s mg/kg', round(x_90,1)))
y_90 = ps[which.min(abs((1-ps/p0) - 0.9*(1-p15/p0)))]
lines(c(-10, x_90), rep(100*y_90, 2),lty=2)
lines(c(x_90,x_90), c(-19, 100*y_90),lty=2)
text(x = 1.5, y = 100*y_90 + 2, expression(E[90]),cex=2)

# E50
x_50 = pred_x[which.min(abs((1-ps/p0) - 0.5*(1-p15/p0)))]
writeLines(sprintf('The E50 is %s mg/kg', round(x_50,1)))
y_50 = ps[which.min(abs((1-ps/p0) - 0.5*(1-p15/p0)))]
lines(c(-10, x_50), rep(100*y_50, 2),lty=2)
lines(c(x_50,x_50), c(-19, 100*y_50),lty=2)
text(x = 1.5, y = 100*y_50 + 2, expression(E[50]),cex=2)

# exp(quantile(thetas_all$beta[,1], probs = c(0.025,.5,.975)))

x_95 = pred_x[which.min(abs((1-ps/p0) - 0.95*(1-p15/p0)))]
writeLines(sprintf('The E95 is %s mg/kg', round(x_95,1)))
```

```{r emax_6months, width=7, height=6}
## For the 6 month endpoint
for(i in 1:length(pred_x)){
  thetas_all_6mths$pred_y[,i] = thetas_all_6mths$pred_y[,i]+(thetas_all_6mths$beta[,2]*para_density)
}
ps2 = invlogit(apply(thetas_all_6mths$pred_y,2,mean))
p0_2 = ps2[1]
p15_2 = ps2[length(pred_x)]

par(las=1, cex.lab=1.3, cex.axis=1.3,mar=c(5,5,2,2),family='serif')

plot(pred_x, 100*ps2, lwd=3, type='l',
     xlab = '',col=mycols[1], ylab = '',
     ylim = c(0,65), panel.first=grid())
mtext(text = substitute(paste(italic("P. vivax "), 'recurrence (%)')), 
      side = 2,line = 3,las=3,cex=1.5)
mtext(text = 'Single dose tafenoquine (mg/kg)', 
      side = 1,line = 3,las=1,cex=1.5)
abline(h = 100*invlogit(mean(thetas_all$E0 + 
                               3.5*thetas_all$beta[,1] + 
                               para_density*thetas_all$beta[,2])),
       lty=1, lwd=2,col='darkred')
polygon(c(-10,-10, 100, 100), 
        100*invlogit(quantile(thetas_all_6mths$E0 + 
                                3.5*thetas_all_6mths$beta[,1]+ 
                                para_density*thetas_all_6mths$beta[,2],
                              probs = c(0.025,.975,.975,.025))),
        col = adjustcolor('pink',.3), border = NA)
text(x = 10, y = 2+100*invlogit(mean(thetas_all_6mths$E0 + 3.5*thetas_all_6mths$beta[,1]+
                                       para_density*thetas_all_6mths$beta[,2])),
     'Low-dose primaquine',cex=1.7)

polygon(x = c(pred_x, rev(pred_x)),
        y = 100*invlogit(c(apply(thetas_all_6mths$pred_y, 2, quantile, .975),
                           rev(apply(thetas_all_6mths$pred_y, 2, quantile, .25)))),
        border = NA, col = adjustcolor(mycols[1], .3))
lines(pred_x, 100*ps2, lwd=3,col=mycols[1])

# Max obtainable effect
lines(c(-10, 15), rep(100*p15_2, 2),lty=2)
lines(c(15, 15), c(-19, 100*p15_2),lty=2)
text(x = 1.5, y = 100*p15_2 + 2, expression(E[max]),cex=1.7)

# E90
x_90 = pred_x[which.min(abs((1-ps2/p0_2) - 0.9*(1-p15_2/p0_2)))]
writeLines(sprintf('The E90 is %s mg/kg', round(x_90,1)))
y_90 = ps2[which.min(abs((1-ps2/p0_2) - 0.9*(1-p15_2/p0_2)))]
lines(c(-10, x_90), rep(100*y_90, 2),lty=2)
lines(c(x_90,x_90), c(-19, 100*y_90),lty=2)
text(x = 1.5, y = 100*y_90 + 2, expression(E[90]),cex=1.7)

# E50
x_50 = pred_x[which.min(abs((1-ps2/p0_2) - 0.5*(1-p15_2/p0_2)))]
writeLines(sprintf('The E50 is %s mg/kg', round(x_50,1)))
y_50 = ps2[which.min(abs((1-ps2/p0_2) - 0.5*(1-p15_2/p0_2)))]
lines(c(-10, x_50), rep(100*y_50, 2),lty=2)
lines(c(x_50,x_50), c(-19, 100*y_50),lty=2)
text(x = 1.5, y = 100*y_50 + 2, expression(E[50]),cex=1.7)

x_95 = pred_x[which.min(abs((1-ps2/p0_2) - 0.95*(1-p15_2/p0_2)))]
writeLines(sprintf('The E95 is %s mg/kg', round(x_95,1)))

```

dose-response

```{r dose_response}
thts = cbind(E0=thetas_all$E0,
             Emax=thetas_all$Emax,
             ED50=thetas_all$ED50,
             k=thetas_all$k,
             beta_para = thetas_all$beta[,2])
my_f = function(theta, pred_x) {
  ps = invlogit(theta['E0'] + theta['beta_para'] * para_density +
                  (theta['Emax']*pred_x^theta['k'])/
                  (pred_x^theta['k']+theta['ED50']^theta['k']))
  p0=invlogit(theta['E0'] + theta['beta_para'] * para_density)
  p15=invlogit(theta['E0'] + theta['beta_para'] * para_density +
                 (theta['Emax']*15^theta['k'])/
                 (15^theta['k']+theta['ED50']^theta['k']))
  rel_effect = 100*(1-(ps-p15)/(p0-p15))
  return(rel_effect)
}
rel_effects = apply(thts, 1, my_f, pred_x=pred_x)
rel_effects300 = apply(thts, 1, my_f,pred_x=300/outcome_dat$weight)
rel_effects450 = apply(thts, 1, my_f,pred_x=450/outcome_dat$weight)

layout(mat = matrix(c(1,2,2,2,2,2),nrow = 6))
par(las=1, cex.lab=1.5, cex.axis=1.5,mar=c(0,5,2,2), family='serif')
hist(300/outcome_dat$weight, xlim = range(pred_x),
     ylab='',xaxt='n',xlab='',yaxt='n',col = brewer.pal(8,'Pastel2')[7],
     main='', breaks = seq(0,15,by=.5))
abline(v=quantile(300/outcome_dat$weight, probs = c(.1, .5, .9)), lty=c(2,1,2))

par(las=1, cex.lab=1.8, cex.axis=1.8,mar=c(5,5,0,2))
plot(pred_x, rowMeans(rel_effects), lwd=3, type='l',
     xlab = 'Single dose tafenoquine (mg/kg)',col=mycols[1],
     ylab = 'Effect relative to 15 mg/kg (%)',
     ylim = c(0,100), panel.first=grid())

y_cis = c(apply(rel_effects, 1, quantile, .975),
          rev(apply(rel_effects, 1, quantile, .25)))
polygon(x = c(pred_x, rev(pred_x)),y = y_cis,
        border = NA, col = adjustcolor(mycols[1], .4))
abline(v=quantile(300/outcome_dat$weight, probs = c(.1, .5, .9)), lty=c(2,1,2))

par(mfrow=c(1,1), mar=c(5,5,2,2))
plot(density(rel_effects450), xlim = c(0,100), main='', lwd=3,lty=2,
     ylab='', yaxt='n', xlab='Effect relative to 15 mg/kg (%)',
     panel.first=grid())
lines(density(rel_effects300), lwd=3, lty=1)
legend('topleft', legend = c(300, 450), title = 'TQ dose (mg/kg)',
       inset=0.03, lty=1:2, lwd=3, cex=1.5)

print('mean efficacies:')
mean(rel_effects300)
mean(rel_effects450)
```

compare logistic and EMAX

```{r compare_logistic_EMAX}
par(las=1, family='serif', mar=c(5,5,2,2), 
    cex.axis=1.5, cex.lab=1.5)
mod=glmer(outcome_primary ~ pqmgkgtot + tqmgkgtot + logpara0 + (1|studysite),
          family='binomial', data = outcome_dat)
fixef(mod)
plot(pred_x, 100*predict(mod,  data.frame(pqmgkgtot=0,tqmgkgtot=pred_x,
                                          logpara0=3.5,studysite= -1), re.form=NA,
                         type='response'), type='l',lwd=3,lty=2,
     ylab='', xlab='', panel.first=grid())
mtext(text = substitute(paste(italic("P. vivax "), 'recurrence (%)')), 
      side = 2,line = 3,las=3,cex=1.5)
mtext(text = 'Single dose tafenoquine (mg/kg)', 
      side = 1,line = 3,las=1,cex=1.5)
lines(pred_x, 100*ps, lwd=3, lty=1)

legend('topright', inset = 0.03, legend = c('Logistic','Emax'),lty=2:1,lwd=2,cex=1.5)
```

## Number needed to treat 

weight versus efficacy

```{r abs_effect_by_weight}
ind_300 = pred_x >= 300/140 & pred_x <= 300/35
plot(300/pred_x[ind_300], ps[ind_300], type='l',lwd=3,ylim = c(0,1))
ind_450 = pred_x >= 450/140 & pred_x <= 450/35
lines(450/pred_x[ind_450], ps[ind_450],lty=2, lwd=3)

f300 = approxfun(x = 300/pred_x[ind_300], y = ps[ind_300])
f450 = approxfun(x = 450/pred_x[ind_450], y = ps[ind_450])

layout(mat = matrix(c(1,2,2,2,2,2),nrow = 6))
par(las=1, cex.lab=1.5, cex.axis=1.5,mar=c(0,5,2,2), family='serif')
hist(outcome_dat$weight,
     ylab='',xaxt='n',xlab='',yaxt='n',col = brewer.pal(8,'Pastel2')[7],
     main='', breaks = seq(30,140,by=5), xlim = c(35, 140))
par(las=1, cex.lab=1.8, cex.axis=1.8,mar=c(6,6,0,2))
plot(35:140, 1/(f300(35:140)-f450(35:140)), type='l', lwd=3,
      panel.first=grid(),
     xlab='Weight (kg)', ylab='Number needed to treat')
text(x = 80, y = 13, '450 vs 300 mg', cex=2)
```



overall number needed to treat

```{r NNT}
dose_mg_kg_300 = 300/sample(outcome_dat$weight, size = 10000, replace = T)
dose_mg_kg_450 = 450/sample(outcome_dat$weight, size = 10000, replace = T)
dose_mg_kg_600 = 600/sample(outcome_dat$weight, size = 10000, replace = T)
dose_mg_kg_max = 15

log_para = sample(outcome_dat$logpara0, size = 10000, replace = T)

p_rec_300 = p_rec_450 = p_rec_600 = array(dim = 1000)
ind = sample(1:length(thetas_all$E0),size = 1000, replace = T)
for(i in 1:1000){
  
  p_rec_300[i] = mean(invlogit(thetas_all$E0[ind[i]]+thetas_all$beta[ind[i],2]*log_para+ (thetas_all$Emax[ind[i]]*dose_mg_kg_300^thetas_all$k[ind[i]])/(dose_mg_kg_300^thetas_all$k[ind[i]]+thetas_all$ED50[ind[i]]^thetas_all$k[ind[i]])))
  
  p_rec_450[i] = mean(invlogit(thetas_all$E0[ind[i]]+thetas_all$beta[ind[i],2]*log_para+ (thetas_all$Emax[ind[i]]*dose_mg_kg_450^thetas_all$k[ind[i]])/(dose_mg_kg_450^thetas_all$k[ind[i]]+thetas_all$ED50[ind[i]]^thetas_all$k[ind[i]])))
  
  p_rec_600[i] = mean(invlogit(thetas_all$E0[ind[i]]+thetas_all$beta[ind[i],2]*log_para+ (thetas_all$Emax[ind[i]]*dose_mg_kg_600^thetas_all$k[ind[i]])/(dose_mg_kg_600^thetas_all$k[ind[i]]+thetas_all$ED50[ind[i]]^thetas_all$k[ind[i]])))
  
}
writeLines('Mean recurrence for 300 mg:')
round(100*quantile(p_rec_300, probs = c(0.025, .5, .975)),1)
writeLines('Mean recurrence for 450 mg:')
round(100*quantile(p_rec_450, probs = c(0.025, .5, .975)),1)
writeLines('Mean recurrence for 600 mg:')
round(100*quantile(p_rec_600, probs = c(0.025, .5, .975)),1)

par(family='serif', cex.axis=1.3, cex.lab=1.3)
plot(density(1/(p_rec_300-p_rec_450)), xlab = 'Number needed to treat',main='',
     ylab='', yaxt='n', panel.first=grid(),lwd=3)
writeLines('NNT (95%CI):')
round(quantile(1/(p_rec_300-p_rec_450), probs = c(0.025, .5, .975)),1)
```

Compare for different parts of the world

```{r by_region, fig.width=8, fig.height=4}
table(outcome_dat$region)
mod_rg_glm=list()

for(rg in unique(outcome_dat$region)){
  ind = outcome_dat$region==rg
  myk = which(rg == unique(outcome_dat$region))
  mod_rg_glm[[myk]] =
    stan_glmer(outcome_primary ~ tqmgkgtot + logpara0 + (1|studysite),
               family='binomial', data = outcome_dat[ind, ],
               verbose=FALSE,refresh=0)
}

for(rg in unique(outcome_dat$region)){
  myk = which(rg == unique(outcome_dat$region))
  writeLines(sprintf('In %s the odds ratio for recurrence for each additional mg/kg increase in tafenoquine dose is %s (n=%s)',rg, round(exp(fixef(mod_rg_glm[[myk]])['tqmgkgtot']),3),
                     nobs(mod_rg_glm[[myk]])))
}
```

Compare all ORs for logistic regression models

```{r forest_plot_ORs}
logistic_models = list(mod_mgkg_all, mod_mgkg_sens, mod_mgkg_all_6mths)
logistic_models = c(logistic_models, mod_rg_glm)
names(logistic_models)=c('All (4 months)','300 mg (4 months)','All (6 months)',
                         paste0(unique(outcome_dat$region),' (4 months)'))
ors = sapply(logistic_models, function(x) {
  y = posterior_interval(x, prob=0.95,pars='tqmgkgtot')
  out= c(y,fixef(x)['tqmgkgtot'])
  return(out)
})

xlims =range(c(0, range(ors)))
par(las=1, mar=c(5,12,2,2), cex.lab=1.3, cex.axis=1.3, family='serif',bty='n')
plot(ors['tqmgkgtot', ], 1:length(logistic_models),
     xlim=range(pretty(xlims)),pch=16,cex=2,
     xlab='Odds ratio for recurrence per tafenoquine mg/kg increase',
     panel.first=grid(), ylab='', yaxt='n', xaxt='n')
abline(v=0,lty=2)
for(i in 1:length(logistic_models)){
  lines(ors[1:2, i], c(i,i),lwd=2)
}
axis(2, at = 1:length(logistic_models), labels=names(logistic_models),tick = F)
axis(1, at = pretty(xlims), labels = signif(exp(pretty(xlims)),2))
```

# AUC

```{r}
mod_auc_all = stan_glmer(outcome_primary ~ scale(AUC) + logpara0 + (1|studysite),
                         family='binomial', data = outcome_dat,
                         verbose=FALSE,refresh=0)
writeLines(
  sprintf('Using all data (n=%s), the odds ratio for recurrence at 6 months for each additional mg/kg of tafenoquine is %s (95%% CI %s to %s)',
          nobs(mod_auc_all),
          round(exp(fixef(mod_auc_all)['scale(AUC)']),2),
          round(exp(posterior_interval(mod_auc_all,
                                       pars='scale(AUC)',prob = 0.95)[1]),2),
          round(exp(posterior_interval(mod_auc_all,
                                       pars='scale(AUC)',prob = 0.95)[2]),2)))


mod_auc_weightadj = stan_glmer(outcome_primary ~ scale(AUC) + tqmgkgtot + logpara0 + (1|studysite),
                               family='binomial', data = outcome_dat,
                               verbose=FALSE,refresh=0)
writeLines(
  sprintf('Using all data (n=%s), and adjusted for TQ mg/kg dose, the odds ratio for recurrence at 6 months for each SD in TQ AUC %s (95%% CI %s to %s)',
          nobs(mod_auc_weightadj),
          round(exp(fixef(mod_auc_weightadj)['scale(AUC)']),2),
          round(exp(posterior_interval(mod_auc_weightadj,
                                       pars='scale(AUC)',prob = 0.95)[1]),2),
          round(exp(posterior_interval(mod_auc_weightadj,
                                       pars='scale(AUC)',prob = 0.95)[2]),2)))

mod_auc_300 = stan_glmer(outcome_primary ~ scale(AUC) + logpara0 + (1|studysite),
                         family='binomial', data = outcome_dat[ind_sensitivity,],
                         verbose=FALSE,refresh=0)
writeLines(
  sprintf('Using patients who got 300 mg (n=%s), the odds ratio for recurrence at 6 months for each additional mg/kg of tafenoquine is %s (95%% CI %s to %s)',
          nobs(mod_auc_300),
          round(exp(fixef(mod_auc_300)['scale(AUC)']),2),
          round(exp(posterior_interval(mod_auc_300,
                                       pars='scale(AUC)',prob = 0.95)[1]),2),
          round(exp(posterior_interval(mod_auc_300,
                                       pars='scale(AUC)',prob = 0.95)[2]),2)))
```

# CMAX

```{r}
mod_cmax_all = stan_glmer(outcome_primary ~ log2(CMAX) + logpara0 + (1|studysite),
                          family='binomial', data = outcome_dat,
                          verbose=FALSE,refresh=0)
writeLines(sprintf('Using all data (n=%s), the odds ratio for recurrence at 6 months for each 2-fold increase in tafenoquine CMAX is %s (95%% CI %s to %s)',
                   nobs(mod_cmax_all),
                   round(exp(fixef(mod_cmax_all)['log2(CMAX)']),2),
                   round(exp(posterior_interval(mod_cmax_all,
                                                pars='log2(CMAX)',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_cmax_all,
                                                pars='log2(CMAX)',prob = 0.95)[2]),2)))


mod_Cmax_weightadj = stan_glmer(outcome_primary ~ log2(CMAX) + tqmgkgtot + logpara0 + (1|studysite),
                                family='binomial', data = outcome_dat,
                                verbose=FALSE,refresh=0)
writeLines(
  sprintf('Using all data (n=%s), and adjusted for TQ mg/kg dose, the odds ratio for recurrence at 6 months for a 2-fold increase in TQ Cmax %s (95%% CI %s to %s)',
          nobs(mod_Cmax_weightadj),
          round(exp(fixef(mod_Cmax_weightadj)['log2(CMAX)']),2),
          round(exp(posterior_interval(mod_Cmax_weightadj,
                                       pars='log2(CMAX)',prob = 0.95)[1]),2),
          round(exp(posterior_interval(mod_Cmax_weightadj,
                                       pars='log2(CMAX)',prob = 0.95)[2]),2)))

plot(mod_Cmax_weightadj, pars=c('tqmgkgtot','log2(CMAX)'))
mod_cmax_300 = stan_glmer(outcome_primary ~ log2(CMAX) + logpara0 + (1|studysite),
                          family='binomial', data = outcome_dat[ind_sensitivity, ],
                          verbose=FALSE,refresh=0)


writeLines(sprintf('Using who got 300 mg (n=%s), the odds ratio for recurrence at 6 months for each 10 fold increase in tafenoquine CMAX is %s (95%% CI %s to %s)',
                   nobs(mod_cmax_300),
                   round(exp(fixef(mod_cmax_300)['log2(CMAX)']),2),
                   round(exp(posterior_interval(mod_cmax_300,
                                                pars='log2(CMAX)',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_cmax_300,
                                                pars='log2(CMAX)',prob = 0.95)[2]),2)))
```

# Terminal elimination half-life

```{r}
mod=lm(t_12_terminal_rescaled ~ log(weight)+country, data = outcome_dat)
summary(mod)
boxplot(t_12_terminal_rescaled ~ country, data = outcome_dat,las=2,xlab='')


plot(outcome_dat$weight, outcome_dat$t_12_terminal_rescaled)
outcome_dat$t_12_terminal_rescaled[outcome_dat$t_12_terminal_rescaled>30]=NA
cor.test(outcome_dat$weight, outcome_dat$t_12_terminal_rescaled)


mod_t_12 = stan_glmer(outcome_primary ~ t_12_terminal_rescaled + (1|studysite),
                      family='binomial', data = outcome_dat,
                      verbose=F, refresh=0)
writeLines(sprintf('Using all data (n=%s), the odds ratio for recurrence at 4 months for each additional day in the tafenoquine half life is %s (95%% CI %s to %s)',
                   nobs(mod_t_12),
                   round(exp(fixef(mod_t_12)['t_12_terminal_rescaled']),2),
                   round(exp(posterior_interval(mod_t_12,pars='t_12_terminal_rescaled',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_t_12,pars='t_12_terminal_rescaled',prob = 0.95)[2]),2)))

mod_t_12_weightadj = stan_glmer(outcome_primary ~ t_12_terminal_rescaled + tqmgkgtot + (1|studysite),
                                family='binomial', data = outcome_dat,
                                verbose=F, refresh=0)
writeLines(sprintf('Using all data (n=%s), the odds ratio for recurrence at 4 months for each additional day in the tafenoquine half life is %s (95%% CI %s to %s)',
                   nobs(mod_t_12_weightadj),
                   round(exp(fixef(mod_t_12_weightadj)['t_12_terminal_rescaled']),2),
                   round(exp(posterior_interval(mod_t_12_weightadj,pars='t_12_terminal_rescaled',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_t_12_weightadj,pars='t_12_terminal_rescaled',prob = 0.95)[2]),2)))

plot(mod_t_12_weightadj,pars=c('tqmgkgtot', 't_12_terminal_rescaled'))

mod_t_12_sens = stan_glmer(outcome_primary ~ t_12_terminal_rescaled + (1|studysite),
                           family='binomial', data = outcome_dat[ind_sensitivity,],
                           verbose=F, refresh=0)
writeLines(sprintf('Using patients given 300 mg (n=%s), the odds ratio for recurrence at 4 months for each additional day in the tafenoquine half life is %s (95%% CI %s to %s)',
                   nobs(mod_t_12_sens),
                   round(exp(fixef(mod_t_12_sens)['t_12_terminal_rescaled']),2),
                   round(exp(posterior_interval(mod_t_12_sens,pars='t_12_terminal_rescaled',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_t_12_sens,pars='t_12_terminal_rescaled',prob = 0.95)[2]),2)))
```

# Methaemoglobin

```{r}
mod_mthb_all = stan_glmer(outcome_primary ~ day7_mthb + tqmgkgtot + logpara0 + (1|studysite),
                          family='binomial', data = outcome_dat[outcome_dat$tqmgkgtot>0, ],
                          verbose=F, refresh=0)

writeLines(sprintf('Using all TQ treated patients (n=%s), the odds ratio for recurrence at 4 months for each absolute percentage increase in methaemoglobin is %s (95%% CI %s to %s)',
                   nobs(mod_mthb_all),
                   round(exp(fixef(mod_mthb_all)['day7_mthb']),2),
                   round(exp(posterior_interval(mod_mthb_all,pars='day7_mthb',prob = 0.95)[1]),2),
                   round(exp(posterior_interval(mod_mthb_all,pars='day7_mthb',prob = 0.95)[2]),2)))



# only patients with recorded outcome (excludes those who dropped out after 1 month FUP)
ind_include = !is.na(outcome_dat$outcome_primary) & !is.na(outcome_dat$day7_mthb) & outcome_dat$tqmgkgtot>0
mod_emax_mthb = 
  sampling(emax_stan, 
           data=list(N=sum(ind_include),
                     Ksites = length(unique(outcome_dat$studysite[ind_include])),
                     recurrence = outcome_dat$outcome_primary[ind_include],
                     dose_mg_kg = outcome_dat$tqmgkgtot[ind_include],
                     K_cov = 2,
                     x = matrix(cbind(outcome_dat$day7_mthb[ind_include],
                                      outcome_dat$logpara0[ind_include]),
                                nrow = sum(ind_include)),
                     studysite = as.numeric(as.factor(as.character(outcome_dat$studysite[ind_include]))),
                     K=length(pred_x),
                     pred_x = pred_x),
           save_warmup = FALSE,
           pars=c('theta'), # we don't save these as it takes up vast memory!
           include=FALSE,
           verbose=FALSE,refresh=0)

beta_mthb = extract(mod_emax_mthb, pars='beta')$beta[,1]
writeLines(sprintf('Under the TQ mg/kg dose EMAX model, each absolute percentage point increase in methaemglobin as associated in an odds-ratio for recurrence at 4 months of %s (95%% CI %s to %s)',
                   round(exp(mean(beta_mthb)),2),
                   round(exp(quantile(beta_mthb,0.025)),2),
                   round(exp(quantile(beta_mthb,0.975)),2)))
```

# Everything

```{r comparison_all_predictors, fig.height=5}
mod_everything0 = 
  glmer(outcome_primary ~ tqmgkgtot +
          scale(log(day7_mthb)) +
          scale(t_12_terminal_rescaled) + 
          scale(logpara0) +
          (1|studysite),
        family = 'binomial', 
        data = outcome_dat)
summary(mod_everything0)

mod_everything = 
  stan_glmer(outcome_primary ~ tqmgkgtot + 
               day7_mthb +
               t_12_terminal_rescaled + 
               logpara0 +
               (1|studysite),
             family = 'binomial', 
             data = outcome_dat, 
             prior = normal(0,1),
             iter=4000,chain=4,seed=12345,refresh=0)

writeLines(sprintf('Full model has %s datapoints', nobs(mod_everything)))
mypars = c('tqmgkgtot',
           'day7_mthb', 
           't_12_terminal_rescaled')
# 'scale(logpara0)')
# mcmc_intervals(mod_everything,pars=mypars)
xx=data.frame(cbind(mean = fixef(mod_everything)[mypars],
                    posterior_interval(mod_everything,pars=mypars,prob = 0.95),
                    posterior_interval(mod_everything,pars=mypars,prob = 0.8)))

par(las=1, cex.lab=1.3, cex.axis=1.3, family='serif',bty='n',
    mar=c(5,13,3,2))
plot(xx$mean, 1:nrow(xx), xlim=range(xx), yaxt='n', ylab='',
     xlab='Odds-ratio for recurrence at 4 months', xaxt='n',
     panel.first=grid(),pch=16, cex=2)
abline(v=0,lty=2, lwd=2)
axis(2, at = 1:nrow(xx), labels = c('Tafenoquine\n(mg/kg increase)',
                                    # 'Tafenoquine Cmax',
                                    # 'Tafenoquine AUC',
                                    'Day 7 methaemoglobin\n(absolute % point increase)',
                                    'Terminal half-life\n(day increase)'),
     # 'Parasite density (log)'),
     tick = F)
for(i in 1:nrow(xx)){
  lines(xx[i,2:3], c(i,i))
  lines(xx[i,4:5], c(i,i),lwd=3)
}
axis(1, at = log(c(0.65, 0.8, 1, 1.2)),
     labels = c(0.65, 0.8, 1, 1.2),tick = T)
```

CYP2D6

```{r}
table(outcome_dat$AS_score[ind_efficacy&outcome_dat$tqmgkgtot>0] <=0.5)

table(outcome_dat$AS_score[ind_efficacy&outcome_dat$tqmgkgtot>0] <=0.5,
      outcome_dat$country[ind_efficacy&outcome_dat$tqmgkgtot>0])

mod_everything0 = 
    glmer(outcome_primary ~ tqmgkgtot + as.numeric(AS_score <=0.5) +
              (1|studysite),
          family = 'binomial', 
          data = outcome_dat[ind_efficacy&outcome_dat$tqmgkgtot>0,])
summary(mod_everything0)
xx=summary(mod_everything0)$coefficients
ccs=round(exp(xx['as.numeric(AS_score <= 0.5)',1] + c(-1.96, 0, 1.96) *  xx['as.numeric(AS_score <= 0.5)',2]),1)
writeLines(sprintf('OR for recurrence for poor versus normal/extensive CYP2D6 metabolisers is %s [95%% CI is %s to %s]',ccs[2],ccs[1],ccs[3]))
```

## Phase 1: relationship with DHA/PQP?

```{r methb_ACT}
pk_summaries$ACT = factor(pk_summaries$ACT, levels = c('CQ','None','AL','DHA/PQP'))

pk_summaries$AMT = round(pk_summaries$BW*pk_summaries$tqmgkgtot)
boxplot(day7_mthb ~ ACT, data = pk_summaries[pk_summaries$AMT==300, ])

layout(mat = matrix(data = c(rep(1, 3*4),2:5),nrow = 4, byrow = F))
par(las=1, cex.axis=1.5, cex.lab=1.5, family='serif')
boxplot(log10(day7_mthb) ~ ACT, data = pk_summaries[pk_summaries$AMT==300, ],
        xlab='', ylab='Day 7 methaemoglobin (%)', yaxt='n', 
        ylim = c(log10(0.3), log10(9)))
axis(2, at = log10(c(0.3, 1, 3)), labels = c(0.3, 1, 3))
axis(2, at = log10(c(0.3, 3)), labels = c(0.3, 3))
axis(2, at = log10(seq(0.3, 1, by=.1)), labels = NA)
axis(2, at = log10(seq(1, 10, by=1)), labels = NA)

for(act in c('CQ','AL','DHA/PQP','None')){
  hist(pk_summaries$BW[which(pk_summaries$AMT==300 & pk_summaries$ACT==act)],
       main=act, breaks=seq(35,140,by=5),ylab='', yaxt='n',xlab = 'weight (kg)')
}


mod_ACT = glm(log10(day7_mthb) ~ tqmgkgtot + TYPE, 
              data = pk_summaries)
summary(mod_ACT)

table(pk_summaries$ACT[!is.na(pk_summaries$day7_mthb) & ! is.na(pk_summaries$tqmgkgtot)])
```

# Power calculations and trial design

```{r revised_dosing}
# f_weight = function(w_kg, w_doses, w_cuts){
#   out=w_doses[as.numeric(cut(x = w_kg, 
#                              breaks = w_cuts,
#                              include.lowest=T))]
#   return(out)
# }
# w_cuts_standard = c(10, 20, 35, 150)
# w_dose_standard = c(100, 200, 300)
# 
# w_cuts_revised = c(10, 15,  20,  30,   45,  60, 80, 150)
# w_dose_revised = c(  150, 200, 250, 300, 450, 600, 750)
# 
# xs=seq(10,100,length.out=1000)
# par(las=1, cex.lab=1.5, cex.axis = 1.5, mar=c(0,5,2,2))
# layout(mat = matrix(c(1,2,2,2,2)))
# hist(outcome_dat$weight,main='',yaxt='n', ylab='',
#      xlim = range(xs), breaks = seq(10,150,by=5), xaxt='n',xlab='')
# par(mar=c(5,5,0,2))
# plot(xs, f_weight(xs, w_doses = w_dose_standard, 
#                   w_cuts = w_cuts_standard)/xs,
#      type='l',lwd=3,panel.first = grid(),ylim = c(0,15),
#      xlab='Weight (kg)', ylab = 'Tafenoquine mg/kg dose',
#      xaxt='n')
# axis(1, at = union(w_cuts_standard, w_cuts_revised))
# lines(xs, f_weight(xs, w_doses = w_dose_revised, w_cuts = w_cuts_revised)/xs, lwd=3, lty=2,col='red')
# 
# lines(45:100, 450/(45:100),lty=3,col='red',lwd=2)
# lines(45:100, 600/(45:100),lty=3,col='red',lwd=2)
# 
# legend('topright', lwd=3, lty=1:2, col=1:2,
#        legend = c('Current','Revised'), cex=1.5,
#        title = 'Dose', inset=0.03)
# 
# text(x=w_cuts_revised[1:7], 
#      y = rep(c(.3,.6),4)[1:7]+
#        f_weight(w_cuts_revised[1:7]+2,
#                 w_doses = w_dose_revised, 
#                 w_cuts = w_cuts_revised)/w_cuts_revised[1:7],
#      labels = paste0(w_dose_revised[1:7],'mg'), cex=1, col = 'red')
# 
# text(x=w_cuts_standard[1:3]+2, 
#      y = 4,cex=1, col = 'black',
#      labels = paste0(w_dose_standard[1:3],'mg'))
# 
# sim_ws = sample(outcome_dat$weight, size = 10^5, replace = T)
# sim_dose_mgkg_current = f_weight(w_kg = sim_ws, w_doses = w_dose_standard, w_cuts = w_cuts_standard)/sim_ws
# sim_dose_mgkg_revised = f_weight(w_kg = sim_ws, w_doses = w_dose_revised, w_cuts = w_cuts_revised)/sim_ws
# 
# 
# sim_rec_current = predict(mod_mgkg_all_gam, 
#                           newdata = data.frame(tqmgkgtot=sim_dose_mgkg_current,
#                                                logpara0=4,
#                                                studysite = -1),re.form=NA,
#                           type='response')
# 
# sim_rec_revised = predict(mod_mgkg_all_gam, 
#                           newdata = data.frame(tqmgkgtot=sim_dose_mgkg_revised,
#                                                logpara0 = 4,
#                                                studysite = -1),re.form=NA,
#                           type='response')
# 
# sim_450 = predict(mod_mgkg_all_gam, 
#                   newdata = data.frame(tqmgkgtot=450/sim_ws[sim_ws>=45],
#                                        logpara0 = 4,
#                                        studysite = -1),re.form=NA,
#                   type='response')
# 
# sim_600 = predict(mod_mgkg_all_gam, 
#                   newdata = data.frame(tqmgkgtot=600/sim_ws[sim_ws>=45],
#                                        logpara0 = 4,
#                                        studysite = -1),re.form=NA,
#                   type='response')
# 
# 
# writeLines(sprintf('Under the current dosing the mean recurrence proportion within 6 months is %s%%', round(100*mean(sim_rec_current),1)))
# 
# 
# writeLines(sprintf('Under the revised dosing the mean recurrence proportion within 6 months is %s%%', round(100*mean(sim_rec_revised),1)))
# 
# 
# writeLines(sprintf('If all adults>45 kg get 450 mg the mean recurrence proportion within 6 months is %s%%', round(100*mean(sim_450),1)))
# 
# writeLines(sprintf('If all adults>45 kg get 600 mg the mean recurrence proportion within 6 months is %s%%', round(100*mean(sim_600),1)))
```

# Power calculations

Superiority of 450 over 300 mg single dose

```{r power_calc}
# Ns = seq(50, 350, by = 50)
# Sims = 100 # make this large to get accurate curves
# doses = c(450, 600)
# power_mat = array(dim = c(length(Ns), Sims, length(doses)))
# options(warn= -1)
# 
# for(d in 1:length(doses)){
#   for(i in 1:length(Ns)){
#     for(j in 1:Sims){
#       trts = c(rep(300, Ns[i]), rep(doses[d], Ns[i]))
#       ws = sample(outcome_dat$weight, size = 2*Ns[i], replace = T)
#       sim_out = predict(mod_mgkg_all_gam, 
#                         newdata = data.frame(tqmgkgtot=trts/ws,
#                                              logpara0 = 4,
#                                              studysite = -1),
#                         re.form=NA,
#                         type='response')
#       outcomes = rbinom(n = 2*Ns[i], size = 1, prob = sim_out)
#       x_test = fisher.test(table(trts, outcomes))
#       power_mat[i,j,d]=as.numeric(x_test$p.value<0.025 & x_test$estimate<1)
#     }
#   }
# }
# par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
# plot(2*Ns, 100*rowMeans(power_mat[,,1]), type='b', ylim = c(0,100),panel.first=grid(),
#      xlab= 'Sample size (total, 1:1 randomisation)', ylab = 'Power %',lwd=2)
# lines(2*Ns, 100*rowMeans(power_mat[,,2]),type='b',lwd=2,lty=2)
# legend('bottomright', lty=1:2, legend = c('450 mg', '600 mg'),lwd=2,inset=0.03)
```
